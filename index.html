<html><head>
<style>
body {
  font-family: 'Open Sans', sans-serif;
}
#activity-container{
  height: 100%;
  width: 50%;
  float: left;
  overflow: hidden;
}
#activity {
  list-style: none;
  padding: 0;
}
#activity li {
  padding: 5px;
}
#teamDonut, #commitDonut {
  height: 400px;
  width: 45%;
  float: right;
}
#activity li img {
  height: 20px;
  width: 20px;
}
</style>
<link href='http://fonts.googleapis.com/css?family=Open+Sans' rel='stylesheet' type='text/css'>
<script src="http://cdn.pubnub.com/pubnub-3.7.1.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/c3/0.4.10/c3.min.js" type="text/javascript"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/d3/3.5.5/d3.min.js" type="text/javascript"></script>
</head><body>
  <div id="activity-container">
    <h3>Hackathon Activity Log</h3>
    <ul id="activity">
      <li><img src="https://pbs.twimg.com/profile_images/567863388475101184/KwWxV9kh_400x400.jpeg" height="20" width="20"> Dave Nugent just pushed 1 commit
    </ul>
  </div>

<div id="teamDonut"></div>
<div id="commitDonut"></div>
<script>
var pubnub = PUBNUB.init({
  publish_key: 'demo',
  subscribe_key: 'demo'
})
  , activity = document.getElementById('activity')
  , displayMessage = function(m) {
    if(typeof m.avatar_url != 'undefined') {
      activity.innerHTML = "<li><img src='" + m.avatar_url + "'> " + m.name + " just pushed " + m.num_commits + " commits to " + m.repo_name + activity.innerHTML
      
    }
    if(typeof m.team != 'undefined') {
      var d = 0
        , c = 0
        , h = new Date(m.time).getHours();
      if(teamDonut.data(m.team).length > 0 && typeof teamDonut.data(m.team)[0].values[0].value != 'undefined')  {
        d = teamDonut.data(m.team)[0].values[0].value;
      }
      teamDonut.load({ columns: [[m.team, d + 1]] } );
      if(commitDonut.data(m.name).length > 0 && typeof commitDonut.data(m.name)[0].values[0].value != 'undefined')  {
        c = commitDonut.data(m.name)[0].values[0].value;
      }
      commitDonut.load({ columns: [[m.name, c + 1]] } );
    }
  }
  , displayMessages = function(ms) { ms[0].forEach(displayMessage); }
  , displayLiveMessage = function(m) { var aSound = document.createElement('audio');
     if(m.num_commits > 1) {
       aSound.setAttribute('src', 'applause_x.wav');
     } else {
       aSound.setAttribute('src', 'applause_y.wav');
     }
     aSound.play();
    displayMessage(m);
  }
  , teamDonut = c3.generate({
    bindto: "#teamDonut",
    data: {
        columns: [
        ],
        type : 'donut',
        onclick: function (d, i) { console.log("onclick", d, i); },
        onmouseover: function (d, i) { console.log("onmouseover", d, i); },
        onmouseout: function (d, i) { console.log("onmouseout", d, i); }
    },
    donut: {
        title: "Top Commiting Teams"
    }
  })
  , commitDonut = c3.generate({
    bindto: "#commitDonut",
    data: {
        columns: [
        ],
        type : 'donut',
        onclick: function (d, i) { console.log("onclick", d, i); },
        onmouseover: function (d, i) { console.log("onmouseover", d, i); },
        onmouseout: function (d, i) { console.log("onmouseout", d, i); }
    },
    donut: {
        title: "Top Committers"
    }
  })
  ;

pubnub.subscribe({
  channel: 'pubnub-git',
  message: displayLiveMessage,
  error: function (error) {
    // Handle error here
    console.log(JSON.stringify(error));
  }
});
pubnub.history({
  channel: 'pubnub-git',
  callback: displayMessages,
  count: 500
});
</script>
</body></html>
